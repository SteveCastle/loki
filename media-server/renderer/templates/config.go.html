{{ define "config" }}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lowkey Media Server Configuration</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      body {
        overflow: hidden;
        height: 100vh;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .config-wrapper {
        flex: 1;
        overflow-y: auto;
        padding-bottom: var(--space-5);
      }

      .config-sections {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }

      .config-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: var(--space-5);
        border-left: 3px solid var(--accent-primary);
      }

      .config-card--blue {
        border-left-color: var(--accent-blue);
      }

      .config-card--purple {
        border-left-color: var(--accent-purple);
      }

      .config-card--cyan {
        border-left-color: var(--accent-cyan);
      }

      .config-card--pink {
        border-left-color: var(--accent-pink);
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-3);
        font-size: var(--text-base);
      }

      .section-subtitle {
        color: var(--text-muted);
        font-size: var(--text-sm);
        margin-top: calc(var(--space-1) * -1);
        margin-bottom: var(--space-4);
      }

      .fields {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .field-inline {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        flex-wrap: wrap;
      }

      .field-row {
        display: flex;
        gap: var(--space-4);
      }

      .field-row > div {
        flex: 1;
      }

      .value {
        color: var(--text-primary);
        font-family: var(--font-mono);
        word-break: break-all;
        font-size: var(--text-sm);
        background: var(--bg-surface);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
      }

      .input {
        width: 100%;
        padding: var(--space-3);
        box-sizing: border-box;
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        transition: border-color var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--accent-primary-dim);
      }

      textarea.input {
        resize: vertical;
        max-width: 100%;
        min-height: 100px;
        line-height: 1.5;
      }

      select.input {
        cursor: pointer;
      }

      .actions {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
      }

      .config-footer {
        position: sticky;
        bottom: 0;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-subtle);
        padding: var(--space-4) var(--space-5);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

      .btn {
        padding: var(--space-3) var(--space-5);
        border-radius: var(--radius-md);
        cursor: pointer;
        border: none;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: all var(--transition-fast);
      }

      .btn-primary {
        background: var(--accent-primary);
        color: #000;
      }

      .btn-primary:hover {
        background: #00e6b8;
        box-shadow: var(--shadow-glow);
      }

      .btn-secondary {
        background: var(--bg-hover);
        color: var(--text-primary);
        border: 1px solid var(--border-default);
      }

      .btn-secondary:hover {
        background: var(--bg-active);
        border-color: var(--border-strong);
      }

      .status {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-top: var(--space-3);
      }

      .status.success {
        color: var(--status-success);
      }

      .status.error {
        color: var(--status-error);
      }

      .tabs {
        display: flex;
        gap: var(--space-2);
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: var(--space-5);
        padding-bottom: 0;
      }

      .tab-button {
        padding: var(--space-3) var(--space-4);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        color: var(--text-muted);
        font-size: var(--text-base);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        margin-bottom: -1px;
      }

      .tab-button:hover {
        color: var(--text-primary);
      }

      .tab-button.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .config-file-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        color: var(--text-muted);
        text-decoration: none;
        margin-bottom: var(--space-4);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
      }

      .config-file-link:hover {
        color: var(--accent-primary);
        background: var(--bg-surface);
      }

      .config-file-link::before {
        content: 'üìÑ';
        font-size: 1em;
      }

      /* Legacy grid styles for backwards compat */
      .dependencies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: var(--space-5);
      }

      .dependency-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: var(--space-5);
        border-left: 3px solid var(--accent-cyan);
        transition: all 0.2s ease;
      }

      .dependency-card:hover {
        border-color: var(--accent-cyan);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* New dependency list styles */
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        padding: var(--space-3) var(--space-4);
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
      }

      .status-pills {
        display: flex;
        gap: var(--space-3);
      }

      .status-pill {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-xs);
        color: var(--text-muted);
      }

      .pill-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .pill-dot.installed { background: rgb(34, 197, 94); }
      .pill-dot.missing { background: rgb(239, 68, 68); }

      .btn-install-all {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
        color: white;
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-xs);
        font-weight: 600;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-install-all:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
      }

      .btn-install-all:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .section-header {
        font-size: var(--text-xs);
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-3);
        padding-left: var(--space-2);
      }

      .dep-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .dep-item {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        transition: all 0.15s ease;
      }

      .dep-item:hover {
        border-color: var(--accent-cyan);
      }

      .dep-item.installed {
        border-left: 3px solid rgb(34, 197, 94);
      }

      .dep-item.not-installed {
        border-left: 3px solid rgb(239, 68, 68);
      }

      .dep-item.downloading {
        border-left: 3px solid rgb(59, 130, 246);
        background: rgba(59, 130, 246, 0.03);
      }

      .dep-item.outdated {
        border-left: 3px solid rgb(234, 179, 8);
      }

      .dep-item.optional {
        opacity: 0.85;
      }

      .dep-item.optional.installed {
        opacity: 1;
      }

      .dep-header {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
      }

      .dep-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .dep-icon svg {
        width: 16px;
        height: 16px;
      }

      .dep-icon.installed {
        background: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
      }

      .dep-icon.not-installed {
        background: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
      }

      .dep-icon.downloading {
        background: rgba(59, 130, 246, 0.1);
        color: rgb(59, 130, 246);
        animation: pulse 1.5s infinite;
      }

      .dep-icon.outdated {
        background: rgba(234, 179, 8, 0.1);
        color: rgb(234, 179, 8);
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .dep-info {
        flex: 1;
        min-width: 0;
      }

      .dep-name {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .dep-name .optional-badge {
        font-size: var(--text-xs);
        font-weight: 500;
        color: var(--text-muted);
        background: var(--bg-surface);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        margin-left: var(--space-2);
      }

      .dep-description {
        font-size: var(--text-sm);
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .dep-actions {
        display: flex;
        gap: var(--space-2);
        flex-shrink: 0;
      }

      .dep-details {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-3);
        margin-top: var(--space-3);
        padding-top: var(--space-3);
        border-top: 1px solid var(--border-subtle);
      }

      .dep-detail {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .dep-detail-label {
        font-size: var(--text-xs);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .dep-detail-value {
        font-size: var(--text-sm);
        color: var(--text-primary);
      }

      .dep-detail-value.path {
        font-family: monospace;
        font-size: var(--text-xs);
        background: var(--bg-surface);
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .dep-detail-value a {
        color: var(--accent-cyan);
        text-decoration: none;
      }

      .dep-detail-value a:hover {
        text-decoration: underline;
      }

      .dep-progress {
        margin-top: var(--space-2);
        display: none;
      }

      .dep-progress.show {
        display: block;
      }

      .progress-bar-mini {
        height: 4px;
        background: var(--bg-surface);
        border-radius: var(--radius-full);
        overflow: hidden;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
        border-radius: var(--radius-full);
        transition: width 0.3s ease;
      }

      .progress-text {
        font-size: var(--text-xs);
        color: var(--text-muted);
        margin-top: var(--space-1);
      }

      /* Legacy status badge styles */
      .status-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .status-installed {
        background: rgba(34, 197, 94, 0.15);
        color: rgb(34, 197, 94);
      }

      .status-not_installed {
        background: rgba(239, 68, 68, 0.15);
        color: rgb(239, 68, 68);
      }

      .status-outdated {
        background: rgba(234, 179, 8, 0.15);
        color: rgb(234, 179, 8);
      }

      .status-downloading {
        background: rgba(59, 130, 246, 0.15);
        color: rgb(59, 130, 246);
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: var(--text-sm);
      }

      .info-label {
        color: var(--text-muted);
        font-weight: 500;
      }

      .info-value {
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: var(--text-xs);
      }

      .btn-success {
        background: rgba(34, 197, 94, 0.15);
        color: rgb(34, 197, 94);
        cursor: not-allowed;
      }

      .btn-tertiary {
        background: var(--bg-surface);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
      }

      .btn-tertiary:hover:not(:disabled) {
        background: var(--bg-card);
        border-color: var(--accent-cyan);
      }

      .btn-warning {
        background: rgba(234, 179, 8, 0.1);
        color: rgb(234, 179, 8);
      }

      .btn-external {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
        text-decoration: none;
      }

      .btn-external:hover {
        color: var(--accent-cyan);
        border-color: var(--accent-cyan);
      }

      .download-progress {
        display: none;
        margin-bottom: var(--space-4);
        padding: var(--space-3);
        background: var(--bg-surface);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
      }

      .status-message {
        padding: var(--space-3);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
        display: none;
      }

      .status-message.show {
        display: block;
      }

      .status-message.success {
        background: rgba(34, 197, 94, 0.15);
        color: rgb(34, 197, 94);
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .status-message.error {
        background: rgba(239, 68, 68, 0.15);
        color: rgb(239, 68, 68);
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      @media screen and (max-width: 800px) {
        .field-row {
          flex-direction: column;
          gap: var(--space-3);
        }

        .actions .btn {
          flex: 1 1 auto;
          min-width: 120px;
        }

        .dependencies-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      {{ template "topnav" . }}

      <div class="config-wrapper">
        <a href="#" class="config-file-link" id="config-file-link">
          Config file: {{.ConfigPath}}
        </a>

        <div class="tabs">
          <button class="tab-button active" data-tab="configuration">
            Configuration
          </button>
          <button class="tab-button" data-tab="dependencies">
            Dependencies
          </button>
        </div>

        <div id="tab-configuration" class="tab-content active">
          <div class="config-sections">
            <div class="config-card config-card--blue">
              <div class="section-title">‚öôÔ∏è General</div>
              <div class="fields">
                <div class="field">
                  <label class="label">Database path</label>
                  <input
                    id="db-path"
                    class="input"
                    type="text"
                    value="{{.Config.DBPath}}"
                  />
                  <div class="field-inline">
                    <span class="hint">Active:</span>
                    <code
                      class="value"
                      id="active-db-path"
                      style="padding: var(--space-1) var(--space-2)"
                      >{{.ActiveDBPath}}</code
                    >
                  </div>
                </div>
                <div class="field">
                  <label class="label">Download path</label>
                  <input
                    id="download-path"
                    class="input"
                    type="text"
                    value="{{.Config.DownloadPath}}"
                  />
                </div>
              </div>
            </div>

            <div class="config-card config-card--purple">
              <div class="section-title">üí¨ Discord</div>
              <div class="fields">
                <div class="field">
                  <label class="label">User Token</label>
                  <input
                    id="discord-token"
                    class="input"
                    type="password"
                    value="{{.Config.DiscordToken}}"
                    placeholder="Enter your Discord user token"
                  />
                  <div
                    class="hint"
                    style="
                      font-size: 0.8em;
                      color: var(--text-muted);
                      margin-top: 5px;
                    "
                  >
                    Required for exporting media from Discord channels using
                    dce.
                  </div>
                </div>
              </div>
            </div>

            <div class="config-card config-card--purple">
              <div class="section-title">üß† Ollama</div>
              <div class="fields">
                <div class="field">
                  <label class="label">Base URL</label>
                  <input
                    id="ollama-base-url"
                    class="input"
                    type="text"
                    value="{{.Config.OllamaBaseURL}}"
                  />
                </div>
                <div class="field">
                  <label class="label">Model</label>
                  <select id="ollama-model" class="input">
                    <option value="{{.Config.OllamaModel}}">
                      {{.Config.OllamaModel}}
                    </option>
                  </select>
                </div>
                <div class="field">
                  <label class="label">Describe prompt</label>
                  <textarea id="describe-prompt" class="input" rows="4">
{{.Config.DescribePrompt}}</textarea
                  >
                </div>
                <div class="field">
                  <label class="label">Autotag prompt</label>
                  <textarea id="autotag-prompt" class="input" rows="6">
{{.Config.AutotagPrompt}}</textarea
                  >
                </div>
              </div>
            </div>

            <div class="config-card config-card--cyan">
              <div class="section-title">üß© ONNX Tagger</div>
              <div class="fields">
                <div class="field">
                  <label class="label">Model path</label>
                  <input
                    disabled
                    id="onnx-model-path"
                    class="input"
                    type="text"
                    value="{{.Config.OnnxTagger.ModelPath}}"
                  />
                </div>
                <div class="field">
                  <label class="label">Labels path</label>
                  <input
                    id="onnx-labels-path"
                    class="input"
                    type="text"
                    value="{{.Config.OnnxTagger.LabelsPath}}"
                  />
                </div>
                <div class="field">
                  <label class="label">Config path</label>
                  <input
                    id="onnx-config-path"
                    class="input"
                    type="text"
                    value="{{.Config.OnnxTagger.ConfigPath}}"
                  />
                </div>
                <div class="field">
                  <label class="label">ORT shared library path</label>
                  <input
                    id="onnx-ort-path"
                    class="input"
                    type="text"
                    value="{{.Config.OnnxTagger.ORTSharedLibraryPath}}"
                  />
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="label">General threshold</label>
                    <input
                      id="onnx-general-thresh"
                      class="input"
                      type="number"
                      step="0.01"
                      value="{{.Config.OnnxTagger.GeneralThreshold}}"
                    />
                  </div>
                  <div class="field">
                    <label class="label">Character threshold</label>
                    <input
                      id="onnx-char-thresh"
                      class="input"
                      type="number"
                      step="0.01"
                      value="{{.Config.OnnxTagger.CharacterThreshold}}"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="config-card config-card--pink">
              <div class="section-title">üéôÔ∏è Whisper</div>
              <div class="fields">
                <div class="field">
                  <label class="label">Faster-Whisper executable</label>
                  <input
                    disabled
                    id="faster-whisper-path"
                    class="input"
                    type="text"
                    value="{{.Config.FasterWhisperPath}}"
                  />
                </div>
              </div>
            </div>

            <div class="config-card config-card--pink">
              <div class="section-title">üë• User Management</div>
              <div class="fields">
                <div class="field">
                  <label class="label">Create User</label>
                  <div class="field-row">
                    <input
                      id="new-username"
                      class="input"
                      type="text"
                      placeholder="Username"
                    />
                    <input
                      id="new-password"
                      class="input"
                      type="password"
                      placeholder="Password"
                    />
                    <button class="btn btn-secondary" id="create-user-btn">
                      Create
                    </button>
                  </div>
                </div>
                <div class="field">
                  <label class="label">Existing Users</label>
                  <div
                    class="value"
                    style="background: transparent; border: none; padding: 0"
                  >
                    <ul
                      id="user-list"
                      style="
                        list-style: none;
                        padding: 0;
                        margin: 0;
                        display: flex;
                        flex-direction: column;
                        gap: var(--space-2);
                      "
                    >
                      <!-- Users populated via JS -->
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-dependencies" class="tab-content">
          <div id="dependencies-content" style="min-height: 400px">
            <div
              style="
                text-align: center;
                padding: var(--space-6);
                color: var(--text-muted);
              "
            >
              Loading dependencies...
            </div>
          </div>
        </div>
      </div>

      <div class="config-footer">
        <div class="actions">
          <button class="btn btn-primary" id="save-btn">Save</button>
          <button class="btn btn-secondary" id="reload-btn">
            Reload from file
          </button>
        </div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById('status');
      const activeDbPathEl = document.getElementById('active-db-path');
      const configPath = '{{.ConfigPath}}';

      function setStatus(msg, kind = 'info') {
        statusEl.textContent = msg;
        statusEl.className = 'status ' + kind;
      }

      // Tab switching
      document.querySelectorAll('.tab-button').forEach((button) => {
        button.addEventListener('click', () => {
          const tabName = button.dataset.tab;

          // Update buttons
          document
            .querySelectorAll('.tab-button')
            .forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');

          // Update content
          document
            .querySelectorAll('.tab-content')
            .forEach((content) => content.classList.remove('active'));
          document.getElementById(`tab-${tabName}`).classList.add('active');

          // Load dependencies if switching to dependencies tab
          if (tabName === 'dependencies' && !window.dependenciesLoaded) {
            loadDependencies();
          }
        });
      });

      // Config file link
      document
        .getElementById('config-file-link')
        .addEventListener('click', (e) => {
          e.preventDefault();
          fetch('/open', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: configPath }),
          }).catch((err) => {
            console.error('Failed to open config file:', err);
            setStatus('Failed to open config file', 'error');
          });
        });

      // Dependencies loading and management
      let eventSource = null;
      window.dependenciesLoaded = false;

      function loadDependencies() {
        const contentEl = document.getElementById('dependencies-content');
        contentEl.innerHTML =
          '<div style="text-align: center; padding: var(--space-6); color: var(--text-muted);">Loading dependencies...</div>';

        fetch('/dependencies')
          .then((r) => r.text())
          .then((html) => {
            // Extract the dependencies content from the HTML response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Look for action bar, section, and dependencies list
            const actionBar = doc.querySelector('.action-bar');
            const section = doc.querySelector('.section');
            const depList = doc.querySelector('.dep-list') || doc.querySelector('.dependencies-grid');

            if (depList) {
              // Build the content including action bar if available
              let content = '';
              if (actionBar) {
                content += actionBar.outerHTML;
              }
              if (section) {
                content += section.outerHTML;
              } else {
                content += depList.outerHTML;
              }
              contentEl.innerHTML = content;

              // Re-attach event listeners for dependency buttons
              attachDependencyListeners();
              connectDependenciesSSE();

              // Initialize any cards that already have active jobs
              document.querySelectorAll('.dep-item, .dependency-card').forEach((card) => {
                const jobID = card.getAttribute('data-job-id');
                if (jobID) {
                  const progressDiv = card.querySelector('.download-progress') || card.querySelector('.dep-progress');
                  const statusBadge = card.querySelector('.status-badge');
                  if (
                    statusBadge &&
                    statusBadge.textContent.trim() === 'downloading' &&
                    progressDiv
                  ) {
                    progressDiv.style.display = 'block';
                  }
                }
              });

              // Update counts if action bar is present
              updateDependencyCounts();
            } else {
              contentEl.innerHTML =
                '<div style="text-align: center; padding: var(--space-6); color: var(--text-muted);">No dependencies found</div>';
            }
            window.dependenciesLoaded = true;
          })
          .catch((err) => {
            contentEl.innerHTML = `<div style="text-align: center; padding: var(--space-6); color: var(--status-error);">Error loading dependencies: ${err.message}</div>`;
            console.error('Failed to load dependencies:', err);
          });
      }

      function updateDependencyCounts() {
        let installed = 0, missing = 0;
        document.querySelectorAll('.dep-item, .dependency-card').forEach(item => {
          const isOpt = item.dataset.optional === 'true';
          const isInst = item.classList.contains('installed');
          if (!isOpt) {
            if (isInst) installed++;
            else missing++;
          } else if (isInst) {
            installed++;
          }
        });

        const installedEl = document.getElementById('installed-count');
        const missingEl = document.getElementById('missing-count');
        if (installedEl) installedEl.textContent = installed;
        if (missingEl) missingEl.textContent = missing;

        const btn = document.getElementById('install-all-btn');
        if (btn && missing === 0) {
          btn.disabled = true;
          btn.textContent = 'All Installed';
        }
      }

      function attachDependencyListeners() {
        document
          .querySelectorAll('[onclick*="downloadDependency"]')
          .forEach((btn) => {
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/downloadDependency\('([^']+)'\)/);
            if (match) {
              btn.onclick = () => downloadDependency(match[1]);
            }
          });

        document
          .querySelectorAll('[onclick*="reinstallDependency"]')
          .forEach((btn) => {
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/reinstallDependency\('([^']+)'\)/);
            if (match) {
              btn.onclick = () => reinstallDependency(match[1]);
            }
          });

        document
          .querySelectorAll('[onclick*="checkDependency"]')
          .forEach((btn) => {
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/checkDependency\('([^']+)'\)/);
            if (match) {
              btn.onclick = () => checkDependency(match[1]);
            }
          });

        document
          .querySelectorAll('[onclick*="installAll"]')
          .forEach((btn) => {
            btn.onclick = () => installAll();
          });
      }

      let isInstallingAll = false;

      function installAll() {
        if (isInstallingAll) return;

        const btn = document.getElementById('install-all-btn');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Installing...';
        }
        isInstallingAll = true;

        fetch('/downloads/install-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'nothing_to_install') {
            showDependencyStatus('All components installed', 'success');
            if (btn) btn.textContent = 'All Installed';
          } else if (data.status !== 'started') {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Install Missing';
            }
            isInstallingAll = false;
          }
        })
        .catch(() => {
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Install Missing';
          }
          isInstallingAll = false;
        });
      }

      let progressStream = null;

      function connectDependenciesSSE() {
        if (eventSource) return;

        // Connect to main job stream
        eventSource = new EventSource('/stream');

        eventSource.addEventListener('update', (event) => {
          const data = JSON.parse(event.data);
          if (data.job && data.job.command === 'download-dependency') {
            updateDependencyCard(data.job);
          }
        });

        eventSource.addEventListener('message', (event) => {
          const data = JSON.parse(event.data);
          if (data.type && data.type.startsWith('stdout-')) {
            const jobID = data.type.replace('stdout-', '');
            const card = document.querySelector(`[data-job-id="${jobID}"]`);
            if (card) {
              const progressDiv = card.querySelector('.download-progress') || card.querySelector('.dep-progress');
              if (progressDiv) {
                progressDiv.style.display = 'block';
                progressDiv.classList.add('show');
              }
            }
          }
        });

        eventSource.addEventListener('error', () => {
          // SSE errors are expected when connection closes
        });

        // Connect to downloads progress stream
        if (!progressStream) {
          progressStream = new EventSource('/downloads/stream');
          progressStream.addEventListener('progress', (event) => {
            const progress = JSON.parse(event.data);
            handleDownloadProgress(progress);
          });
          progressStream.addEventListener('error', () => {
            // SSE errors are expected when connection closes
          });
        }
      }

      function handleDownloadProgress(progress) {
        if (!progress.dependencies) return;

        for (const dep of progress.dependencies) {
          const item = document.querySelector(`[data-dep-id="${dep.dependency_id}"]`);
          if (!item) continue;

          const icon = item.querySelector('.dep-icon');
          const statusText = document.getElementById(`status-text-${dep.dependency_id}`);
          const progressDiv = document.getElementById(`progress-${dep.dependency_id}`) || item.querySelector('.dep-progress');
          const progressText = document.getElementById(`progress-text-${dep.dependency_id}`);
          const actions = item.querySelector('.dep-actions');

          item.classList.remove('installed', 'not-installed', 'downloading', 'outdated');
          if (icon) icon.classList.remove('installed', 'not-installed', 'downloading', 'outdated');

          switch(dep.status) {
            case 'complete':
              item.classList.add('installed');
              if (icon) {
                icon.classList.add('installed');
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>';
              }
              if (statusText) statusText.textContent = 'Installed';
              if (progressDiv) {
                progressDiv.style.display = 'none';
                progressDiv.classList.remove('show');
              }
              if (actions) {
                actions.innerHTML = `<button class="btn btn-secondary" onclick="reinstallDependency('${dep.dependency_id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>Reinstall</button>`;
              }
              updateDependencyCounts();
              break;

            case 'downloading':
            case 'extracting':
              item.classList.add('downloading');
              if (icon) {
                icon.classList.add('downloading');
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>';
              }
              if (statusText) statusText.textContent = dep.status === 'extracting' ? 'Extracting...' : 'Downloading...';
              if (progressDiv) {
                progressDiv.style.display = 'block';
                progressDiv.classList.add('show');
                const fill = progressDiv.querySelector('.progress-bar-fill');
                if (fill) fill.style.width = dep.percent + '%';
              }
              if (progressText) progressText.textContent = dep.message || `${Math.round(dep.percent)}%`;
              if (actions) {
                actions.innerHTML = '<button class="btn btn-secondary" disabled>Installing...</button>';
              }
              break;

            case 'error':
              item.classList.add('not-installed');
              if (icon) {
                icon.classList.add('not-installed');
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle></svg>';
              }
              if (statusText) statusText.textContent = dep.error || 'Failed';
              if (progressDiv) {
                progressDiv.style.display = 'none';
                progressDiv.classList.remove('show');
              }
              if (actions) {
                actions.innerHTML = `<button class="btn btn-primary" onclick="downloadDependency('${dep.dependency_id}')">Retry</button>`;
              }
              showDependencyStatus(dep.error || 'Installation failed', 'error');
              break;
          }
        }
        attachDependencyListeners();
      }

      function updateDependencyCard(job) {
        const depID = job.input;
        const card = document.querySelector(`[data-dep-id="${depID}"]`);
        if (!card) return;

        // Support both old and new template structures
        const statusBadge = card.querySelector('.status-badge');
        const statusText = document.getElementById(`status-text-${depID}`);
        const actionsDiv = card.querySelector('.dep-actions');
        const progressDiv = card.querySelector('.download-progress') || card.querySelector('.dep-progress');
        const depIcon = card.querySelector('.dep-icon');

        card.setAttribute('data-job-id', job.id);

        const state = job.state;
        if (
          state === 0 ||
          state === 'pending' ||
          state === 'Pending' ||
          state === 1 ||
          state === 'in_progress' ||
          state === 'InProgress'
        ) {
          if (statusBadge) {
            statusBadge.textContent = 'downloading';
            statusBadge.className = 'status-badge status-downloading';
          }
          if (statusText) statusText.textContent = 'Installing...';
          if (progressDiv) {
            progressDiv.style.display = 'block';
            progressDiv.classList.add('show');
          }
          if (depIcon) {
            depIcon.className = 'dep-icon downloading';
            depIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>';
          }
          card.classList.remove('installed', 'not-installed', 'error');
          card.classList.add('downloading');
          if (actionsDiv) {
            actionsDiv.innerHTML = `<button class="btn btn-secondary" disabled>Installing...</button>`;
          }
        } else if (
          state === 2 ||
          state === 'completed' ||
          state === 'Completed'
        ) {
          if (statusBadge) {
            statusBadge.textContent = 'installed';
            statusBadge.className = 'status-badge status-installed';
          }
          if (statusText) statusText.textContent = 'Installed';
          if (progressDiv) {
            progressDiv.style.display = 'none';
            progressDiv.classList.remove('show');
          }
          if (depIcon) {
            depIcon.className = 'dep-icon installed';
            depIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          }
          card.classList.remove('downloading', 'not-installed', 'error');
          card.classList.add('installed');
          if (actionsDiv) {
            actionsDiv.innerHTML = `<button class="btn btn-secondary" onclick="reinstallDependency('${depID}')">Reinstall</button>`;
          }
          showDependencyStatus(`${depID} installed successfully!`, 'success');
        } else if (
          state === 4 ||
          state === 'error' ||
          state === 'Error' ||
          state === 3 ||
          state === 'cancelled' ||
          state === 'Cancelled'
        ) {
          if (statusBadge) {
            statusBadge.textContent = 'not_installed';
            statusBadge.className = 'status-badge status-not_installed';
          }
          if (statusText) statusText.textContent = 'Failed';
          if (progressDiv) {
            progressDiv.style.display = 'none';
            progressDiv.classList.remove('show');
          }
          if (depIcon) {
            depIcon.className = 'dep-icon not-installed';
            depIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle></svg>';
          }
          card.classList.remove('downloading', 'installed');
          card.classList.add('not-installed');
          if (actionsDiv) {
            actionsDiv.innerHTML = `<button class="btn btn-primary" onclick="downloadDependency('${depID}')">Retry</button>`;
          }
          showDependencyStatus(`Download failed for ${depID}`, 'error');
        }
        attachDependencyListeners();
      }

      function reinstallDependency(depID) {
        if (!confirm(`Reinstall ${depID}? This will download and install the latest version.`)) return;
        downloadDependency(depID);
      }

      function showDependencyStatus(message, type) {
        const statusDiv = document.getElementById('dependency-status-message');
        if (!statusDiv) {
          const newDiv = document.createElement('div');
          newDiv.id = 'dependency-status-message';
          newDiv.className = 'status-message';
          document
            .getElementById('dependencies-content')
            .insertBefore(
              newDiv,
              document.getElementById('dependencies-content').firstChild
            );
          newDiv.textContent = message;
          newDiv.className = `status-message ${type} show`;
          setTimeout(() => {
            newDiv.className = 'status-message';
          }, 5000);
        } else {
          statusDiv.textContent = message;
          statusDiv.className = `status-message ${type} show`;
          setTimeout(() => {
            statusDiv.className = 'status-message';
          }, 5000);
        }
      }

      function downloadDependency(depID) {
        const card = document.querySelector(`[data-dep-id="${depID}"]`);
        if (!card) return;

        const statusBadge = card.querySelector('.status-badge');
        const statusText = document.getElementById(`status-text-${depID}`);
        const progressDiv = card.querySelector('.download-progress') || card.querySelector('.dep-progress');
        const actionsDiv = card.querySelector('.dep-actions');
        const depIcon = card.querySelector('.dep-icon');

        // Optimistic update
        if (statusBadge) {
          statusBadge.textContent = 'downloading';
          statusBadge.className = 'status-badge status-downloading';
        }
        if (statusText) statusText.textContent = 'Starting...';
        if (progressDiv) {
          progressDiv.style.display = 'block';
          progressDiv.classList.add('show');
        }
        if (depIcon) {
          depIcon.className = 'dep-icon downloading';
          depIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>';
        }
        card.classList.remove('installed', 'not-installed');
        card.classList.add('downloading');
        if (actionsDiv) {
          actionsDiv.innerHTML = `<button class="btn btn-secondary" disabled>Installing...</button>`;
        }

        // Try new downloads endpoint first, fall back to legacy
        fetch('/downloads/install', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: depID }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.status !== 'started') {
              // Fall back to legacy endpoint
              return fetch('/dependencies/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dependency_id: depID }),
              });
            }
          })
          .catch((err) => {
            showDependencyStatus(`Failed to start download: ${err.message}`, 'error');
          });
      }


      function checkDependency(depID) {
        fetch(`/dependencies/check?id=${depID}`)
          .then((r) => {
            if (!r.ok) throw new Error('Check request failed');
            return r.json();
          })
          .then((data) => {
            showDependencyStatus(
              `Status: ${data.status}, Version: ${data.version || 'unknown'}`,
              'success'
            );
            setTimeout(() => {
              loadDependencies();
            }, 1500);
          })
          .catch((err) => {
            showDependencyStatus(
              `Failed to check status: ${err.message}`,
              'error'
            );
          });
      }

      document.getElementById('save-btn').addEventListener('click', () => {
        const dbPath = document.getElementById('db-path').value.trim();
        if (!dbPath) {
          setStatus('dbPath cannot be empty', 'error');
          return;
        }
        const payload = {
          dbPath,
          downloadPath: document.getElementById('download-path').value.trim(),
          discordToken: document.getElementById('discord-token').value.trim(),
          ollamaBaseUrl: document
            .getElementById('ollama-base-url')
            .value.trim(),
          ollamaModel: document.getElementById('ollama-model').value.trim(),
          describePrompt: document.getElementById('describe-prompt').value,
          autotagPrompt: document.getElementById('autotag-prompt').value,
          onnxModelPath: document
            .getElementById('onnx-model-path')
            .value.trim(),
          onnxLabelsPath: document
            .getElementById('onnx-labels-path')
            .value.trim(),
          onnxConfigPath: document
            .getElementById('onnx-config-path')
            .value.trim(),
          onnxOrtSharedLibPath: document
            .getElementById('onnx-ort-path')
            .value.trim(),
          onnxGeneralThreshold: parseFloat(
            document.getElementById('onnx-general-thresh').value
          ),
          onnxCharacterThreshold: parseFloat(
            document.getElementById('onnx-char-thresh').value
          ),
          fasterWhisperPath: document
            .getElementById('faster-whisper-path')
            .value.trim(),
        };
        setStatus('Saving...');
        fetch('/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then((r) => r.json())
          .then((res) => {
            activeDbPathEl.textContent = res.activeDBPath || dbPath;
            if (res.logoutRequired) {
              setStatus(
                'Database switched. Redirecting to login...',
                'success'
              );
              setTimeout(() => {
                window.location.href =
                  '/login?redirect=' + encodeURIComponent('/config');
              }, 1000);
              return;
            }
            setStatus(
              res.dbChanged
                ? 'Saved and switched database.'
                : res.changed
                ? 'Saved.'
                : 'Saved (no change).',
              'success'
            );
          })
          .catch((err) => setStatus('Error: ' + err, 'error'));
      });

      document.getElementById('reload-btn').addEventListener('click', () => {
        setStatus('Reloading...');
        fetch('/config')
          .then((r) => r.text())
          .then(() => {
            window.location.reload();
          })
          .catch((err) => setStatus('Error: ' + err, 'error'));
      });

      // Populate Ollama models select
      (function populateOllamaModels() {
        const select = document.getElementById('ollama-model');
        const current = select.value.trim();
        fetch('/ollama/models')
          .then((r) => r.json())
          .then((data) => {
            const models = Array.isArray(data.models) ? data.models : [];
            select.innerHTML = '';
            if (models.length === 0 && current) {
              const opt = document.createElement('option');
              opt.value = current;
              opt.textContent = current;
              select.appendChild(opt);
              return;
            }
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select a model';
            select.appendChild(placeholder);
            for (const m of models) {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              select.appendChild(opt);
            }
            if (current) {
              select.value = current;
              if (select.value !== current) {
                const opt = document.createElement('option');
                opt.value = current;
                opt.textContent = current + ' (current)';
                select.insertBefore(opt, select.firstChild.nextSibling);
                select.value = current;
              }
            }
          })
          .catch(() => {});
      })();

      // User Management
      const userListEl = document.getElementById('user-list');
      const createUserBtn = document.getElementById('create-user-btn');

      function loadUsers() {
        fetch('/auth/users')
          .then((r) => r.json())
          .then((data) => {
            if (!data.users) return;
            userListEl.innerHTML = '';
            data.users.forEach((user) => {
              const li = document.createElement('li');
              li.style.cssText =
                'display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);';
              li.innerHTML = `
                <span>${user.username}</span>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; color: var(--status-error); border-color: var(--status-error);" onclick="deleteUser('${user.username}')">Delete</button>
              `;
              userListEl.appendChild(li);
            });
          })
          .catch((err) => console.error('Failed to load users', err));
      }

      function deleteUser(username) {
        if (!confirm('Are you sure you want to delete user ' + username + '?'))
          return;
        fetch('/auth/users?username=' + encodeURIComponent(username), {
          method: 'DELETE',
        })
          .then((r) => r.json())
          .then((res) => {
            if (res.status === 'deleted') {
              setStatus('User deleted', 'success');
              loadUsers();
            } else {
              setStatus(
                'Failed to delete user: ' + (res.error || 'Unknown error'),
                'error'
              );
            }
          })
          .catch((err) => setStatus('Error deleting user: ' + err, 'error'));
      }

      createUserBtn.addEventListener('click', () => {
        const username = document.getElementById('new-username').value.trim();
        const password = document.getElementById('new-password').value;
        if (!username || !password) {
          setStatus('Username and password required', 'error');
          return;
        }

        fetch('/auth/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        })
          .then(async (r) => {
            if (r.ok) return r.json();
            const text = await r.text();
            throw new Error(text || r.statusText);
          })
          .then((res) => {
            setStatus('User created', 'success');
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            loadUsers();
          })
          .catch((err) => setStatus('Error creating user: ' + err, 'error'));
      });

      // Initial load
      loadUsers();
    </script>
  </body>
</html>
{{ end }}
