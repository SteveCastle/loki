# CI/CD Workflow Documentation

## Overview

This repository uses GitHub Actions for continuous integration and automated releases. The workflow automatically builds, tests, and releases new versions when changes are pushed to the `main` branch.

## Workflow: Release

**File:** `.github/workflows/release.yml`

### Trigger

The workflow runs automatically on every push to the `main` branch.

### Jobs

#### 1. Test Job
Runs all tests to ensure code quality before building releases.

**Steps:**
- Sets up Node.js 18 and Go 1.24
- Installs dependencies using Yarn
- Runs Electron app tests (`yarn test`)
- Runs Go server tests (`go test ./...`)

**Note:** Tests are currently set to `continue-on-error: true` to allow the build process to continue even if tests fail. This should be changed to `false` once all tests are passing consistently.

#### 2. Build and Release Job
Builds binaries for all supported platforms using a matrix strategy.

**Platform Matrix:**
- macOS (latest)
- Ubuntu/Linux (latest)
- Windows (latest)

**Steps:**
- Builds Electron app using `yarn package`
- Builds Go media-server binaries for multiple architectures:
  - Linux: amd64, arm64
  - macOS: amd64, arm64
  - Windows: amd64, arm64
- Uploads all build artifacts for the next job

#### 3. Create Release Job
Creates or updates a GitHub release with all built binaries.

**Steps:**
- Downloads all build artifacts from previous jobs
- Extracts version from `package.json`
- Generates an AI-powered changelog by comparing commits since the last release
- Creates or updates a GitHub release with the version tag
- Uploads all binaries to the release

### Version Management

The workflow uses the version number from `package.json` as the release version. To create a new release:

1. Update the version in `package.json`:
   ```json
   {
     "version": "2.6.9"
   }
   ```

2. Commit and push to `main`:
   ```bash
   git add package.json
   git commit -m "Bump version to 2.6.9"
   git push origin main
   ```

3. The workflow will automatically:
   - Run tests
   - Build binaries for all platforms
   - Create a release tagged as `v2.6.9`
   - Upload all binaries to the release

### Release Artifacts

Each release includes:

**Electron App Binaries:**
- macOS: `.dmg` installer (Intel and Apple Silicon)
- Windows: `.exe` installer
- Linux: `.AppImage`

**Media Server Binaries:**
- `media-server-linux-amd64`
- `media-server-linux-arm64`
- `media-server-darwin-amd64` (Intel Mac)
- `media-server-darwin-arm64` (Apple Silicon)
- `media-server-windows-amd64.exe`
- `media-server-windows-arm64.exe`

### Caching

The workflow uses caching to speed up builds:
- Yarn dependencies are cached by Node.js setup action
- Go modules are cached by Go setup action

### Security

The workflow follows security best practices:
- Minimal permissions (`contents: write`, `pull-requests: read`)
- Uses GitHub's built-in `GITHUB_TOKEN` for authentication
- No external secrets required

### Customization

#### Changing Test Behavior

To make tests required (fail the build on test failure), edit `.github/workflows/release.yml`:

```yaml
- name: Run Electron app tests
  run: yarn test
  # Remove continue-on-error line

- name: Run Go server tests
  working-directory: media-server
  run: go test ./...
  # Remove continue-on-error line
```

#### Adding New Build Targets

To add new platforms or architectures for the Go media-server:

```yaml
- name: Build Go media-server (Linux)
  if: matrix.os == 'ubuntu-latest'
  working-directory: media-server
  run: |
    mkdir -p ../release/build
    GOOS=linux GOARCH=amd64 go build -o ../release/build/media-server-linux-amd64 .
    GOOS=linux GOARCH=arm64 go build -o ../release/build/media-server-linux-arm64 .
    # Add new architecture:
    GOOS=linux GOARCH=386 go build -o ../release/build/media-server-linux-386 .
```

#### Customizing Changelog Generation

The changelog is generated by comparing commits since the last release. You can customize the format by editing the `Generate AI Changelog` step in `.github/workflows/release.yml`.

### Troubleshooting

#### Build Failures

If the workflow fails, check the Actions tab in GitHub to see detailed logs. Common issues:

1. **Dependencies not installed:** Ensure `yarn install` completes successfully
2. **Go build errors:** Check that `go.mod` is up to date and all dependencies are available
3. **Test failures:** Fix failing tests or temporarily set `continue-on-error: true`

#### Release Already Exists

If a release with the same version already exists, the workflow will update it instead of creating a new one. To create a new release, bump the version in `package.json`.

#### Missing Artifacts

If artifacts are missing from the release:
1. Check that the build job completed successfully for all platforms
2. Verify that the artifact upload step succeeded
3. Check that the artifact paths are correct

### Manual Release

To manually trigger a release or test the workflow:

1. Go to the Actions tab in GitHub
2. Select the "Release" workflow
3. Click "Run workflow"
4. Select the `main` branch
5. Click "Run workflow"

Note: Manual triggering is not currently enabled in the workflow configuration. To enable it, add to the workflow:

```yaml
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Add this line
```

## Best Practices

1. **Always test locally before pushing to main:** Use `yarn test` and `yarn package` to verify builds work
2. **Follow semantic versioning:** Use major.minor.patch format (e.g., 2.6.8)
3. **Write meaningful commit messages:** They appear in the changelog
4. **Review the release:** Check the generated release on GitHub to ensure all artifacts are present

## Related Documentation

- [Electron Builder](https://www.electron.build/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Go Build Documentation](https://golang.org/cmd/go/#hdr-Compile_packages_and_dependencies)
